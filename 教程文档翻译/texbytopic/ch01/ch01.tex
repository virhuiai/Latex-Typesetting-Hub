% \chapter{The Structure of the \TeX\ Processor\\\TeX\ 处理器的结构}

% This book treats the various aspects of \TeX\ in chapters
% that are concerned with relatively small, well-delineated,
% topics. In this chapter, therefore, 
% a global picture of the way \TeX\ operates will be given.
% Of necessity, many details will be omitted here, but all of
% these are treated in later chapters. On the other hand,
% the few examples given in this chapter will be repeated
% in the appropriate places later on; they are included here
% to make this chapter self-contained.

% 本书将以涉及相对小而清晰的主题的章节来介绍 \TeX 的各个方面。因此，在本章中，将给出 \TeX\ 运行方式的整体图景。当然，这里有很多细节被省略了，但所有这些细节在后面的章节中都有涉及。另一方面，本章中给出的一些示例将在适当的地方再次出现；它们包含在这里是为了使本章内容自成一体。



% %\point Four \TeX\ processors
% \section{Four \TeX\protect\ processors\\四个 \TeX\ 处理器}

% The way \TeX\ processes its input can be viewed as
% happening on four levels. One might  say that
% the \TeX\ processor is split into four separate units,
% each one accepting the output of the previous stage, and
% delivering the input for the next stage. The input of
% the first stage is then the \n{.tex} input file; the output
% of the last stage is a \n{.dvi} file.

% \TeX\ 处理输入的方式可以看作是在四个层次上进行的。可以说 \TeX\ 处理器被分为四个独立的单元，每个单元接受前一阶段的输出，并产生下一阶段的输入。第一阶段的输入是 \n{.tex} 输入文件；最后一阶段的输出是一个 \n{.dvi} 文件。

% For many purposes it is most convenient, and most insightful,
% to consider these four levels of processing as happening
% after one another, each one accepting the {\em completed\/}
% output of the previous level. In reality this is not true:
% all levels are simultaneously
% active, and there is interaction between them.

% 对于许多情况，将这四个处理层次依次考虑是最方便和最有洞察力的，每个层次接受上一层次的{\em 完整}输出。实际上，这并不完全正确：所有层次都是同时活动的，并且它们之间存在相互作用。



% The four levels are (corresponding roughly
% to the `eyes', `mouth', `stomach', and `bowels' respectively
% in Knuth's original terminology) as follows.

% 这四个层次（与 Knuth 最初的术语“眼睛”、“嘴巴”、“胃”和“肠道”相对应）如下所示：




% \begin{enumerate}\item
% The input processor. This is the piece of \TeX\ that
% accepts input lines from the file system of whatever computer
% \TeX\ runs on, and turns them into tokens.
% Tokens are the internal objects of \TeX:
% there are character tokens that constitute the typeset
% text, and control sequence tokens that are commands 
% to be processed by the next two levels.

% 输入处理器。这是 \TeX\ 的一部分，它从 \TeX\ 运行所在计算机的文件系统接受输入行，并将它们转换为记号。记号是 \TeX\ 的内部对象：其中有构成排版文本的字符记号，还有作为下两个层次处理的命令的控制序列记号。
% \item The expansion processor. 
% Some but not all of the tokens generated in the first level
% \ldash macros, conditionals, and a number
% of primitive \TeX\ commands \rdash  are subject to expansion.
% Expansion is the process that replaces some (sequences of)
% tokens by other (or no) tokens.

% 展开处理器。在第一层次生成的记号中，一些（但不是全部）\ldash 宏、条件语句和一些原始 \TeX\ 命令 \rdash 可以进行展开。展开是将一些（序列的）记号替换为其他（或不替换）记号的过程。
% \item The execution processor. 
% Control sequences that are not expandable are executable,
% and this execution takes place on the third level of the
% \TeX\ processor.

% 执行处理器。不可展开的控制序列是可执行的，并且这个执行过程发生在 \TeX\ 处理器的第三层次上。


% One part of the activity here concerns changes to
% \TeX's internal state: assignments (including
% macro definitions) are typical activities in this
% \awp
% category. The other major thing happening on this level
% is the construction of horizontal, vertical, and
% mathematical lists.

% 活动的一部分涉及到 \TeX\ 的内部状态的更改：赋值（包括宏定义）是这一类别中的典型活动。在此层次上发生的另一项主要事务是构建水平、垂直和数学列表。
% \item The visual processor. 
% In the final level of processing
% the visual part of \TeX\ processing is performed. Here
% horizontal lists are broken into paragraphs, 
% vertical lists are broken into pages,
% and  formulas are built out of math lists. 
% Also the output to the \n{dvi} file takes place on this level.
% The algorithms working here are not accessible to the user,
% but they can be influenced by a number of parameters.

% 视觉处理器。在处理的最后一层中，执行 \TeX\ 的视觉处理。在这里，水平列表被分割为段落，垂直列表被分割为页面，并且数学列表被构建为公式。此外，输出到 \n{dvi} 文件也在此层次上进行。在此处工作的算法用户无法访问，但可以通过多个参数进行调整。
% \end{enumerate}



% %\point The input processor
% \section{The input processor\\输入处理器}

% The input processor of \TeX\ is that part of \TeX\ that
% translates whatever characters it gets from the input file
% into tokens. The output of this processor is a stream
% of tokens: a token list. Most tokens fall into one of two categories:
% character tokens and control sequence tokens. 
% The remaining category is that of the parameter tokens;
% these will not be treated in this chapter.

% \TeX\ 的输入处理器是将输入文件中获取的字符转换为记号的 \TeX\ 的一部分。该处理器的输出是一系列记号：一个记号列表。大多数记号属于以下两个类别之一：字符记号和控制序列记号。剩下的类别是参数记号；这些在本章中不进行讨论。

% %\spoint Character input
% \subsection{Character input\\字符输入}

% For simple input text, characters are made into
% character tokens. However, \TeX\ can ignore input characters:
% a row of spaces in the input is usually equivalent to just one
% space. Also, \TeX\ itself can insert tokens that do not correspond
% to any character in the input, for instance the space token
% at the end of the line, or the \cs{par} token after an empty line.

% 对于简单的输入文本，字符被转换为字符记号。但是，\TeX\ 可以忽略输入字符：输入中的多个空格通常等效为一个空格。此外，\TeX\ 本身可以插入不对应任何输入字符的记号，例如行末的空格记号，或空行后的 \cs{par} 记号。





% Not all character tokens signify characters to be typeset.
% \altt
% Characters fall into sixteen categories \ldash each one
% specifying a certain function that a character can have \rdash 
% of which only two contain the characters that will be
% typeset. The other categories contain such characters 
% as~\n{\char`\{}, \n{\char`\}}, 
% \n\&, and~\n\#. A~character token can be considered
% as a pair of numbers: the character code \ldash typically the \ascii\
% code \rdash  and the category code.
% It is possible to change
% the category code that is associated with a particular
% character code.

% 并非所有字符记号都表示要排版的字符。\altt
% 字符分为十六个类别 \ldash 每个类别指定字符可以具有的某个功能 \rdash 其中只有两个类别包含将要排版的字符。%
% 其他类别包含诸如 ~\n{\char`\{}, \n{\char`\}}, \n\&, 和~\n\# 等字符。%
% 字符记号可以被视为一对数：字符码（通常是 \ascii\ 码）和类别码。可以更改与特定字符码相关联的类别码。

% When the escape character (by default~\cs{}$\,$) appears in the input,
% \TeX's behaviour in forming tokens is more complicated. 
% Basically,
% \TeX\ builds a control sequence by taking a number of characters
% from the input and lumping them together into a single token.

% 当转义字符（默认为 \cs{}$,$）出现在输入中时，\TeX\ 形成记号的行为更加复杂。基本上，\TeX\ 通过从输入中取出一些字符并将它们组合成一个单独的记号来构建控制序列。



% The behaviour with which \TeX's input processor 
% reacts to category codes can be described
% as a machine that switches between three internal states:
% $N$,~new line; $M$,~middle of line; $S$,~skipping spaces.
% These states and the transitions between them are treated
% in Chapter~\ref{mouth}.

% \TeX\ 的输入处理器对类别码的反应可以被描述为在三个内部状态之间切换的机器：$N$，新行；$M$，行中间；$S$，跳过空格。这些状态及其之间的转换在第~\ref{mouth}~章中进行讨论。



% %\spoint Two-level input processing
% \subsection{Two-level input processing\\两级输入处理}

% \TeX's input processor is in fact itself a two-level processor.
% Because of limitations of the terminal, the editor, or the operating
% \awp
% system, the user may not be able to input certain desired characters.
% Therefore, \TeX\ provides a mechanism to access
% with two superscript characters all of the available character
% positions. This may be considered
% a separate stage of \TeX\ processing, taking place
% prior to the three-state machine mentioned above.

% 实际上，\TeX\ 的输入处理器本身就是一个两级处理器。由于终端、编辑器或操作系统的限制，用户可能无法输入某些期望的字符。因此，\TeX\ 提供了一种机制，通过两个上标字符来访问所有可用的字符位置。这可以被视为 \TeX\ 处理的一个单独阶段，在上述三状态机之前进行。


% For instance, the sequence \verb>^^+> is replaced by~\n{k} because
% the \ascii{} codes of \n k and \n + differ by~64. 
% Since this replacement takes place before tokens are formed,
% writing \verb>\vs^^+ip 5cm> has the same effect as
% \verb>\vskip 5cm>. Examples more useful than this exist.

% 例如，序列 \verb>^^+> 会被替换为~\n{k}，因为 \n k 和 \n + 的 \ascii{} 码之差为~64。由于这种替换发生在记号形成之前，编写 \verb>\vs^^+ip 5cm> 的效果与 \verb>\vskip 5cm> 相同。存在比这更有用的示例。


% Note that this first stage is a transformation from
% characters to characters, without considering category
% codes. These come into play only in the second phase
% of input processing where characters are converted
% to character tokens by coupling the category code
% to the character code.

% 注意，这个第一阶段是从字符到字符的转换，而不考虑类别码。只有在输入处理的第二阶段，字符才通过将类别码与字符码相结合，转换为字符记号时起作用。


% %\point The expansion processor
% \section{The expansion processor\\展开处理器}

% \TeX's  expansion processor accepts a stream of tokens
% and, if possible, 
% expands the tokens in this stream one by one
% until only unexpandable tokens remain.
% Macro expansion is the clearest example of this:
% if a control sequence is a macro name, it is replaced
% (together possibly with parameter tokens) by 
% the definition text of the macro.

% \TeX\ 的展开处理器接受一系列记号，并在可能的情况下逐个展开这些记号，直到只剩下不可展开的记号为止。宏展开是最明显的例子：如果一个控制序列是宏名，它将被宏的定义文本（可能连同参数记号）替换。

% Input for the expansion processor is provided mainly
% by the input processor. The stream of tokens coming
% from the first stage of \TeX\ processing is subject
% to the expansion process, and the result is a stream
% of unexpandable tokens which is fed to the execution processor.

% 展开处理器的输入主要由输入处理器提供。来自 \TeX\ 处理的第一阶段的记号流会经过展开处理，结果是一系列不可展开的记号，这些记号会被馈送给执行处理器。

% However, the expansion processor comes into play 
% also when (among others) an \cs{edef} or \cs{write} is processed.
% The parameter token list of these commands is
% expanded very much as if the lists had been
% on the top level, instead of the argument to a command.

% 然而，展开处理器还在处理（等等）\cs{edef} 或 \cs{write} 等命令时发挥作用。这些命令的参数记号列表的展开非常类似于列表位于顶层，而不是命令的参数中。

